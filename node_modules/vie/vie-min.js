//     VIE - Vienna IKS Editables
//     (c) 2011 Henri Bergius, IKS Consortium
//     VIE may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://wiki.iks-project.eu/index.php/VIE
(function(){var a;typeof exports!="undefined"?a=exports:a=this.VIE={};var b=this._;!b&&typeof require!="undefined"&&(b=require("underscore")._);if(!b)throw"VIE requires underscore.js to be available";var c=this.Backbone;!c&&typeof require!="undefined"&&(c=require("backbone"));if(!c)throw"VIE requires Backbone.js to be available";var d=this.jQuery;!d&&typeof require!="undefined"&&(d=require("jquery"));if(!d)throw"VIE requires jQuery to be available";a.EntityManager={entities:null,initializeCollection:function(){a.EntityManager.entities===null&&(a.EntityManager.entities=new a.RDFEntityCollection)},getBySubject:function(b){a.EntityManager.initializeCollection(),typeof b=="string"&&a.RDFa._isReference(b)&&(b=a.RDFa._fromReference(b));if(typeof b=="object")return a.EntityManager.entities.detect(function(a){if(a.id===b)return!0;return!1});return a.EntityManager.entities.get(b)},getByType:function(b){a.EntityManager.initializeCollection(),a.RDFa._isReference(b)&&(b=a.RDFa._fromReference(b));return a.EntityManager.entities.select(function(a){if(a.type===b)return!0;return!1})},getPredicate:function(c){var d=[];b.forEach(a.EntityManager.entities.pluck("dcterms:hasPart"),function(a){a&&d.push(a)});return d},getByJSONLD:function(b,c){a.EntityManager.initializeCollection();var e,f;if(typeof b!="object")try{b=d.parseJSON(b)}catch(g){return null}typeof b["@"]!="undefined"&&(e=a.EntityManager.getBySubject(b["@"]));if(e){f=a.EntityManager._JSONtoProperties(b,e.attributes,e.id),e.set(f,c),!e.type&&typeof b.a!="undefined"&&(e.type=a.RDFa._fromReference(b.a));return e}f=a.EntityManager._JSONtoProperties(b,{},a.EntityManager._normalizeSubject(b["@"])),e=new a.RDFEntity(f),typeof b["#"]!="undefined"&&(e.namespaces=b["#"]),typeof b.a!="undefined"&&(e.type=a.RDFa._fromReference(b.a)),e.id=a.EntityManager._normalizeSubject(b["@"]),a.EntityManager.registerModel(e);return e},registerModel:function(b){b.id=a.EntityManager._normalizeSubject(b.id),a.EntityManager.entities.indexOf(b)===-1&&a.EntityManager.entities.add(b)},_normalizeSubject:function(b){if(typeof b=="string"){a.RDFa._isReference(b)&&(b=a.RDFa._fromReference(b));return b}if(typeof b=="object")return b;return undefined},_referencesToModels:function(c){b.isArray(c)||(c=[c]);var d=[];b.forEach(c,function(b){d.push(a.EntityManager.getByJSONLD({"@":b}))});return d},_JSONtoProperties:function(c,e,f){var g,h,i;g=d.extend({},c),delete g["@"],delete g.a,delete g["#"],b.each(g,function(b,c){if(a.RDFa._isReference(b)||typeof b=="object")h=a.EntityManager._referencesToModels(b),e[c]instanceof a.RDFEntityCollection?(d.each(h,function(){e[c].indexOf(this)===-1&&e[c].add(this)}),g[c]=e[c]):(g[c]=new a.RDFEntityCollection(h),f&&(g[c].subject=a.EntityManager._normalizeSubject(f),g[c].predicate=c))});return g},cleanup:function(){a.EntityManager.entities=new a.RDFEntityCollection}},a.RDFEntity=c.Model.extend({namespaces:{},type:"",getSubject:function(){if(typeof this.id=="string"){if(this.id.substr(0,7)==="http://")return a.RDFa._toReference(this.id);return this.id}return this.cid.replace("c","_:bnode")},toJSONLD:function(){var c=this,d={},e;b.each(c.attributes,function(b,e){b=c.get(e),b instanceof a.RDFEntityCollection?d[e]=b.map(function(b){return b.id?a.RDFa._toReference(b.id):b.cid.replace("c","_:bnode")}):d[e]=b}),d["@"]=c.getSubject(),c.namespaces.length>0&&(d["#"]=c.namespaces),c.type&&(d.a=a.RDFa._toReference(c.type));return d}}),a.RDFEntityCollection=c.Collection.extend({model:a.RDFEntity,initialize:function(){this.bind("add",this.registerItem)},registerItem:function(c,d){d!==a.EntityManager.entities&&(b.each(c.attributes,function(b,d){if(a.RDFa._isReference(b)){var e=a.EntityManager._referencesToModels(b);c.attributes[d]=new a.RDFEntityCollection(e)}}),a.EntityManager.registerModel(c))}}),a.RDFaEntities={Views:[],CollectionViews:[],getInstance:function(b){b=d(b);var c,e;e=a.RDFa.readEntity(b);if(!e)return null;c=a.EntityManager.getByJSONLD(e),a.RDFaEntities._registerView(c,b);return c},_getViewInstance:function(b,c){var e,f=a.RDFaEntities.Views;b=d(b),c&&(f=a.RDFaEntities.CollectionViews),d.each(f,function(){if(this.el.get(0)===b.get(0)){e=this;return!1}});return e},_registerCollectionView:function(b,c){var e,f;c=d(c),e=a.RDFaEntities._getViewInstance(c,!0);if(e)return e;f=c.children(":first-child"),e=new a.RDFaCollectionView({collection:b,model:b.model,el:c,elementTemplate:f,tagName:c.get(0).nodeName}),a.RDFaEntities.CollectionViews.push(e);return e},_registerView:function(c,e,f){var g;e=d(e),g=a.RDFaEntities._getViewInstance(e);if(g)return g;g=new a.RDFaView({model:c,el:e,tagName:e.get(0).nodeName}),a.RDFaEntities.Views.push(g),b.each(c.attributes,function(b,g){b=c.get(g),b instanceof a.RDFEntityCollection&&d.each(a.RDFa._getElementByPredicate(g,e),function(){a.RDFaEntities._registerCollectionView(b,this),f&&b.trigger("refresh",b)})});return g},getInstances:function(b){var c=[],e;typeof b=="undefined"&&(b=d(document)),d(a.RDFa.subjectSelector,b).add(d(b).filter(a.RDFa.subjectSelector)).each(function(){e=a.RDFaEntities.getInstance(this),e&&c.push(e)});return c},cleanup:function(){a.RDFaEntities.Views=[]}},a.RDFaView=c.View.extend({initialize:function(){b.bindAll(this,"render"),this.model.bind("change",this.render)},render:function(){a.RDFa.writeEntity(this.el,this.model.toJSONLD());return this}}),a.RDFaCollectionView=c.View.extend({elementTemplate:null,initialize:function(){this.elementTemplate=this.options.elementTemplate,b.bindAll(this,"addItem","removeItem","refreshItems"),this.collection.bind("add",this.addItem),this.collection.bind("remove",this.removeItem),this.collection.bind("refresh",this.refreshItems)},refreshItems:function(a){var b=this;d(this.el).empty(),a.forEach(function(c){b.addItem(c,a)})},addItem:function(b,c){if(c===this.collection){if(!this.elementTemplate||this.elementTemplate.length===0)return;var e=a.RDFaEntities._registerView(b,a.RDFa._cloneElement(this.elementTemplate),!0),f=e.render().el;b.id&&typeof b.id=="string"?a.RDFa.setSubject(f,b.id):b.id=f.get(0);var g=this.collection.indexOf(b),h=d(this.el).children();h.length===0||g>h.length-1?d(this.el).append(f):d(this.el).children().each(function(a,b){if(a>=g){d(b).before(f);return!1}}),this.trigger("add",e),f.show(),b.id||(b.id=a.RDFa.getSubject(f)),d(f).parent("[rev]").each(function(){var c={"@":b.id},e=d(this).attr("rev");c[e]=a.RDFa.getSubject(this),a.EntityManager.getByJSONLD(c)})}},removeItem:function(b){d(a.RDFa.subjectSelector,this.el).filter(function(){if(a.RDFa.getSubject(this)===a.RDFa._toReference(b.id))return!0}).each(function(){d(this).remove()});return}}),a.RDFa={Namespaces:{},subjectSelector:"[about],[typeof],[src],html",predicateSelector:"[property],[rel]",getSubject:function(b){if(typeof document!="undefined"&&b===document)return document.baseURI;var c;d(b).closest(a.RDFa.subjectSelector).each(function(){if(d(this).attr("about")){c=d(this).attr("about");return!0}if(d(this).attr("src")){c=d(this).attr("src");return!0}if(d(this).attr("typeof")){c=this;return!0}d(this).get(0).nodeName==="HTML"&&d(this).find("base").each(function(){c=d(this).attr("href")})});if(!c)return undefined;if(typeof c=="object")return c;return a.RDFa._toReference(c)},setSubject:function(a,b){if(d(a).attr("src"))return d(a).attr("src",b);d(a).attr("about",b)},getPredicate:function(a){var b;a=d(a),b=a.attr("property"),b||(b=a.attr("rel"));return b},readEntity:function(b){var c,e,f={},g,h,i;e=a.RDFa.getSubject(b),c=a.RDFa._getElementProperties(e,b,!1);if(d.isEmptyObject(c))return null;for(i in c)if(c.hasOwnProperty(i)){var j=i.split(":");j.length===2&&(g=a.RDFa._resolveNamespace(j[0],b),g&&(f[j[0]]=g))}d.isEmptyObject(f)||(c["#"]=f),h=a.RDFa._getElementValue(b,"typeof"),h&&(c.a=a.RDFa._toReference(h)),c["@"]=e;return c},readEntities:function(b){var c=[],e;typeof b=="undefined"&&(b=d(document)),d(a.RDFa.subjectSelector,b).add(d(b).filter(a.RDFa.subjectSelector)).each(function(){e=a.RDFa.readEntity(this),e&&c.push(e)});return c},writeEntity:function(b,c){a.RDFa.findPredicateElements(a.RDFa.getSubject(b),b,!0).each(function(){var b=d(this),e=b.attr("property");typeof c[e]=="undefined"&&(c[e]=e),a.RDFa._readPropertyValue(e,b)!==c[e]&&a.RDFa._writePropertyValue(b,c[e])});return this},findPredicateElements:function(b,c,e){typeof b=="string"&&!a.RDFa._isReference(b)&&(b=a.RDFa._toReference(b));return d(c).find(a.RDFa.predicateSelector).add(d(c).filter(a.RDFa.predicateSelector)).filter(function(){if(a.RDFa.getSubject(this)!==b)return!1;if(!e){if(!d(this).parents("[property]").length)return!0;return!1}return!0})},_isReference:function(a){var b=new RegExp("^\\<([^\\>]*)\\>$");if(b.exec(a))return!0;return!1},_toReference:function(a){return"<"+a+">"},_fromReference:function(c){if(b.isArray(c))return b.map(c,function(b){return a.RDFa._fromReference(b)});return c.substring(1,c.length-1)},_readPropertyValue:function(b,c){var e=c.attr("content");if(e)return e;var f=c.attr("resource");if(f)return a.RDFa._toReference(f);var g=c.attr("href");if(g&&c.attr("rel")===b)return a.RDFa._toReference(g);if(c.attr("rel")){var h=[];d(c).children(a.RDFa.subjectSelector).each(function(){h.push(a.RDFa.getSubject(this))});return h}return c.html()},_writePropertyValue:function(a,b){if(b instanceof Array||a.attr("rel"))return!0;var c=a.attr("content");if(c)a.attr("content",b);else{var d=a.attr("resource");d&&a.attr("resource",b),a.html(b)}},_resolveNamespace:function(b,c){if(typeof a.RDFa.Namespaces[b]!="undefined")return a.RDFa.Namespaces[b];d("[xmlns\\:"+b+"]").each(function(){a.RDFa.Namespaces[b]=d(this).attr("xmlns:"+b)});return a.RDFa.Namespaces[b]},_getElementValue:function(a,b){a=d(a);if(typeof a.attr(b)!="undefined")return a.attr(b);return a.children("["+b+"]").attr(b)},_getElementByPredicate:function(b,c){var e=a.RDFa.getSubject(c);return d(c).find(a.RDFa.predicateSelector).add(d(c).filter(a.RDFa.predicateSelector)).filter(function(){if(a.RDFa.getPredicate(this)!==b)return!1;if(a.RDFa.getSubject(this)!==e)return!1;return!0})},_getElementProperties:function(b,c,e){var f={};a.RDFa.findPredicateElements(b,c,!0).each(function(){var b,c,g=d(this);b=a.RDFa.getPredicate(this),c=a.RDFa._readPropertyValue(b,g);if(c!==null||!!e){if(typeof f[b]!="undefined"){if(f[b]instanceof Array){if(e)return;f[b].push(c);return}var h=f[b];f[b]=[];if(e)return;f[b].push(h),f[b].push(c);return}if(e){f[b]="";return}f[b]=c}}),d(c).get(0).tagName!=="HTML"&&d(c).parent("[rev]").each(function(){f[d(this).attr("rev")]=a.RDFa.getSubject(this)});return f},_cloneElement:function(b){b=d(b).clone(!1),typeof b.attr("about")!="undefined"&&b.attr("about",""),b.find("[about]").attr("about","");var c=a.RDFa.getSubject(b);a.RDFa.findPredicateElements(c,b,!1).each(function(){a.RDFa._writePropertyValue(d(this),"")});return b},cleanup:function(){a.RDFa.Namespaces={}}},a.cleanup=function(){a.EntityManager.cleanup(),a.RDFaEntities.cleanup(),a.RDFa.cleanup()}}).call(this)